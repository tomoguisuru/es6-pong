<!doctype html>
<html>
  <head>
  </head>
  <body>
    <canvas id="gameCanvas" height="600" width="800"></canvas>
    <script>
      window.onload = function() {
        const canvas = document.getElementById('gameCanvas');
        const context = canvas.getContext('2d');
        new Pong(canvas, context);
      }

      class Pong {
        constructor(canvas, context) {
          this.canvas = canvas;
          this.canvasContext = context;
          this.fps = 30;

          const { width, height } = this.canvas;
          this.balls = [
            new Ball(canvas, context),
          ];

          this.paddles = [
            new Paddle(canvas, context),
            new Paddle(canvas, context, 'right'),
          ];

          setInterval(() => {         
            this.collisions();
            this.draw();

          }, 1000/this.fps);
        }

        collisions() {
          const { width, height } = this.canvas;

          this.balls.forEach(ball => {
            const ballRight = ball.x + ball.radius;
            this.paddles.forEach(paddle => {
              let hit =  (paddle.side === 'left') 
                ? (ball.x <= paddle.x + paddle.width)
                : ball.x + ball.radius >= paddle.x;

              if (hit && (ball.y >= paddle.y && ball.y <= paddle.y + paddle.height)) {
                ball.xVelocity *= -1;
               }
            });

            if (ball.x <= 0) {
              this.score(ball);
            }

            if (ballRight >= width) {
              this.score(ball);
            }
          });
        }

        draw() {
          const { width, height } = this.canvas;
          this.canvasContext.fillStyle = 'black';
          this.canvasContext.fillRect(0, 0, width, height);

          this.balls.forEach(_e => _e.draw());
          this.paddles.forEach(_e => _e.draw());
        }

        score(ball) {
          ball.resetPosition();
        }
      }

      class Paddle {
        constructor(canvas, context, side = 'left') {
          this.canvas = canvas;
          this.canvasContext = context;
          this.side = side;
          this.height = 100;
          this.width = 5;
          this.yVelocity = 30;
          this.KEY_CODES =  {
            left: { 87: -this.yVelocity, 83: this.yVelocity },
            right: { 38: -this.yVelocity, 40: this.yVelocity },
          }

          const { width, height } = this.canvas;

          this.resetPosition();
          this.addEventListeners();
        }

        resetPosition() {
          const { width, height } = this.canvas;

          this.x = this.side === 'left'
            ? 10
            : width - (10 + this.width);

          this.y = (height - this.height)/2;
        }

        mouseMove(evt) {
          const rect = this.canvas.getBoundingClientRect();
          const root = document.documentElement;

          return { 
            x: evt.clientX - rect.left - root.scrollLeft, 
            y: evt.clientY - rect.top - root.scrollTop, 
          }
        }

        addEventListeners() {
          const { height } = this.canvas;

          //if (this.side === 'left') { return; }

          // this.canvas.addEventListener('mousemove', (evt) => {
          //   const { x, y } = this.mouseMove(evt);
          //   this.y = y - (this.height/2);

          //   if (this.y < 0) {
          //        this.y = 0;
          //   }

          //   if (this.y + this.height > height) {
          //     this.y = height - this.height;
          //   }
          // });

          document.addEventListener('keydown', (event) => {
            const codes = this.KEY_CODES[this.side];
            const e = codes[event.keyCode];

            if (e) {
              this.y += e;

              if (this.y < 0) {
                this.y = 0;
              }

              if (this.y + this.height > height) {
                this.y = height - this.height;
              }
            }
          });
        }

        draw() {
          const { width, height } = this.canvas;
          this.canvasContext.fillStyle = 'white';
          this.canvasContext.fillRect(this.x, this.y, this.width, this.height);
        }
      }

      class Ball {
        constructor(canvas, context) {
          this.canvas = canvas;
          this.canvasContext = context;

          const { width, height } = this.canvas;

          // Set init position
          this.radius = 5;
          this.resetPosition();
        }

        resetPosition() {
          const { width, height } = this.canvas;

          const randomize = (min, max) => {
            const genInRange = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            const direction = genInRange(0, 1);
            const val = genInRange(min, max);

            return direction 
              ? -val
              : val;
          };

          this.x = (width - this.radius)/2;
          this.y = (height - this.radius)/2;
          this.xVelocity = randomize(8, 11);
          this.yVelocity = randomize(1, 10);
        }

        draw() {
          const { width, height } = this.canvas;
          this.canvasContext.fillStyle = 'white';
          this.canvasContext.beginPath();
          this.canvasContext.arc(this.x, this.y, this.radius, 0, Math.PI*2);
          this.canvasContext.fill();

          if (this.y >= (height - (this.radius*2)) || this.y <= 0) {
            this.yVelocity *= -1;
          }

          this.x += this.xVelocity;
          this.y += this.yVelocity;
        }
      }
    </script>
  </body>
</html>